# Makefile for Lab03-Blinky, ELEC424 Fall 2014
# Authors: Jie Liao, Abeer Javed, Steven Arroyo. Rice University 
# Derived from the crazyflie-firmware Makefile

# Path Definitions
STM_LIB := ../../STM32F10x_StdPeriph_Lib_V3.5.0/Libraries
INCLUDE_DIR = inc
LINK_DIR = linker_script
STARTUP_DIR := $(STM_LIB)/CMSIS/CM3/DeviceSupport/ST/STM32F10x/startup/gcc_ride7
SYSTEM_LIBRARY_INCLUDE := ../../STM32F10x_StdPeriph_Lib_V3.5.0/Libraries/STM32F10x_StdPeriph_Driver/inc/
SYSTEM_LIBRARY_SRC := ../../STM32F10x_StdPeriph_Lib_V3.5.0/Libraries/STM32F10x_StdPeriph_Driver/src/
OTHER_INCLUDE_LIB := ../../STM32F10x_StdPeriph_Lib_V3.5.0/Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/
CORE_INCLUDE_LIB := ../../STM32F10x_StdPeriph_Lib_V3.5.0/Libraries/CMSIS/CM3/CoreSupport/
#??

# Compiler 
CC = arm-none-eabi-gcc

# Particular processor
PROCESSOR = -mcpu=cortex-m3 -mthumb

# Directories of used header files
##INCLUDE = ??
Include = $(INCLUDE_DIR)/blinky.h

# STM chip specific flags
#STFLAGS = -DSTM32F10X_MD -include $(??)/stm32f10x_conf.h
STFLAGS = -DSTM32F10X_MD -I $(SYSTEM_LIBRARY_INCLUDE) -I $(OTHER_INCLUDE_LIB) -I $(CORE_INCLUDE_LIB) -I $(INCLUDE_DIR) -include $(INCLUDE_DIR)/stm32f10x_conf.h

# Define the compiler flags
#CFLAGS = -O0 -g3 $(PROCESSOR) $(INCLUDE) $(STFLAGS) -Wl,--gc-sections -T $(??)/stm32_flash.ld
CFLAGS = -O0 -g3 $(PROCESSOR) $(INCLUDE) $(STFLAGS) -Wl,--gc-sections -T $(LINK_DIR)/stm32_flash.ld 

# Source files to include
#I added this
FILES_TO_LINK := $(SYSTEM_LIBRARY_SRC)/stm32f10x_rcc.c
FILES_TO_LINK += $(SYSTEM_LIBRARY_SRC)/stm32f10x_gpio.c
FILES_TO_LINK += $(STM_LIB)/CMSIS/CM3/DeviceSupport/ST/STM32F10x/system_stm32f10x.c

# Build all relevant files and create .elf
all: 
	#@$(CC) $(CFLAGS) $(??)/startup_stm32f10x_md.s ??
	#gcc -c -o bin/blinky.o src/blinky.c $(CFLAGS)
	# gcc -c -o bin/blinky.o src/blinky.c
	@$(CC) $(CFLAGS) $(STARTUP_DIR)/startup_stm32f10x_md.s -o bin/blinky.elf src/blinky.c $(FILES_TO_LINK)
	# @$(CC) $(CFLAGS) -o bin/blinky.elf src/blinky.c 

# Program .elf into Crazyflie flash memory via the busblaster
flash:
#	??
#	@openocd -d0 -f interface/busblaster.cfg -f target/stm32f1x.cfg -c init -c targets -c "reset halt" -c "flash write_image erase bin/blinky.elf" -c "verify_image bin/blinky.elf" -c "reset run" -c shutdown
	@openocd -d0 -f interface/busblaster.cfg -f target/stm32f1x.cfg -c init -c targets -c "reset halt" -c "flash write_image erase bin/blinky.elf" -c "verify_image bin/blinky.elf" -c "reset run" -c shutdown


# Runs OpenOCD, opens GDB terminal, and establishes connection with Crazyflie
debug:
#	??
	@openocd -d0 -f interface/busblaster.cfg -f target/stm32f1x.cfg -c init -c targets -c "reset halt" -c "target remote:3333"

# Remove all files generated by target 'all'
clean:
#	??
